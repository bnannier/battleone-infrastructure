#cloud-config

# Update packages and install dependencies
package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - unzip
  - jq

# Add additional SSH keys for access
ssh_authorized_keys:
  - ${ssh_public_key}
  %{ if laptop_ssh_public_key != "" ~}
  - ${laptop_ssh_public_key}
  %{ endif ~}

# Create directories
runcmd:
  # Create application directory
  - mkdir -p /opt/battleone
  
  # Install Docker Compose (if not already installed)
  - curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  
  # Add docker-compose to PATH for convenience
  - ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
  
  # Ensure Docker service is running
  - systemctl enable docker
  - systemctl start docker
  
  # Set environment variables for later use
  - echo "POSTGRES_PASSWORD=${postgres_password}" >> /opt/battleone/.env
  - echo "POSTGRES_USER=${postgres_user}" >> /opt/battleone/.env
  - echo "POSTGRES_DB=${postgres_db}" >> /opt/battleone/.env
  - echo "REDIS_PASSWORD=${redis_password}" >> /opt/battleone/.env
  - echo "DATADOG_API_KEY=${datadog_api_key}" >> /opt/battleone/.env
  - echo "DATADOG_SITE=${datadog_site}" >> /opt/battleone/.env
  - echo "BETTERSTACK_SOURCE_TOKEN=${betterstack_source_token}" >> /opt/battleone/.env
  - echo "BETTERSTACK_INGESTION_HOST=${betterstack_ingestion_host}" >> /opt/battleone/.env

# Set file permissions
write_files:
  - path: /opt/battleone/README.md
    content: |
      # BattleOne Infrastructure
      
      This droplet contains:
      - PostgreSQL database
      - Redis cache
      - Kratos identity management
      
      Services are managed via Docker Compose.
      
      To check status: cd /opt/battleone && docker-compose ps
      To view logs: cd /opt/battleone && docker-compose logs
    permissions: '0644'