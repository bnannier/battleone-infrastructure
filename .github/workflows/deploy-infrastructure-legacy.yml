name: Deploy Infrastructure to Digital Ocean

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'Force redeploy infrastructure even if already running'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY_NAME: ${{ secrets.DO_REGISTRY_NAME }}

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clone and prepare infrastructure
        run: |
          # Clone infrastructure repository
          git clone https://github.com/bnannier/battleone-infrastructure.git infrastructure-deployment
          
          echo "ðŸ“¦ Infrastructure repository cloned"

      - name: Setup SSH
        run: |
          if [ -z "${{ secrets.DO_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ DO_SSH_PRIVATE_KEY secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.DO_DROPLET_IP }}" ]; then
            echo "âŒ DO_DROPLET_IP secret is missing"
            exit 1
          fi
          
          mkdir -p ~/.ssh
          echo "${{ secrets.DO_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Test SSH connectivity
          echo "ðŸ” Testing SSH connectivity..."
          if ! ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${{ secrets.DO_DROPLET_IP }} "echo 'SSH test successful'"; then
            echo "âŒ SSH connection failed to ${{ secrets.DO_DROPLET_IP }}"
            exit 1
          fi
          
          echo "ðŸ”‘ Adding droplet to known hosts..."
          ssh-keyscan -H ${{ secrets.DO_DROPLET_IP }} >> ~/.ssh/known_hosts
          
          # Configure SSH with longer timeouts
          cat >> ~/.ssh/config << EOF
          Host ${{ secrets.DO_DROPLET_IP }}
            ServerAliveInterval 60
            ServerAliveCountMax 10
            ConnectTimeout 30
            TCPKeepAlive yes
          EOF

      - name: Deploy Infrastructure to Digital Ocean
        env:
          DO_DROPLET_IP: ${{ secrets.DO_DROPLET_IP }}
          DO_USERNAME: ${{ secrets.DO_USERNAME }}
          # Database secrets
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          POSTGRES_DB: battleone
          POSTGRES_USER: battleone_user
          KRATOS_LOG_LEVEL: warn
          FORCE_REDEPLOY: ${{ github.event.inputs.force_redeploy }}
        run: |
          # Create directory structure on droplet
          ssh $DO_USERNAME@$DO_DROPLET_IP "mkdir -p /opt/battleone/infrastructure"
          
          # Copy infrastructure files to droplet
          scp -r infrastructure-deployment/* $DO_USERNAME@$DO_DROPLET_IP:/opt/battleone/infrastructure/
          
          # Deploy infrastructure
          ssh $DO_USERNAME@$DO_DROPLET_IP "
            export POSTGRES_PASSWORD='$POSTGRES_PASSWORD'
            export REDIS_PASSWORD='$REDIS_PASSWORD'
            export POSTGRES_DB='$POSTGRES_DB'
            export POSTGRES_USER='$POSTGRES_USER'
            export KRATOS_LOG_LEVEL='$KRATOS_LOG_LEVEL'
            
            cd /opt/battleone/infrastructure
            
            # Check if infrastructure is already running
            if [ '$FORCE_REDEPLOY' = 'true' ] || ! docker ps | grep -q 'battleone-postgres\|battleone-redis\|battleone-kratos'; then
              echo 'ðŸš€ Deploying infrastructure...'
              chmod +x deploy-infrastructure.sh
              ./deploy-infrastructure.sh
            else
              echo 'âœ… Infrastructure already running, skipping deployment'
              echo 'Use force_redeploy=true to redeploy infrastructure'
              docker ps | grep battleone
            fi
          "

      - name: Infrastructure health check
        run: |
          sleep 30
          
          # Test all infrastructure services
          ssh ${{ secrets.DO_USERNAME }}@${{ secrets.DO_DROPLET_IP }} "
            echo 'ðŸ” Testing infrastructure services...'
            
            # Test PostgreSQL
            if docker exec battleone-postgres pg_isready -U battleone_user -d battleone; then
              echo 'âœ… PostgreSQL is healthy'
            else
              echo 'âŒ PostgreSQL health check failed'
              exit 1
            fi
            
            # Test Redis
            if docker exec battleone-redis redis-cli ping | grep -q PONG; then
              echo 'âœ… Redis is healthy'
            else
              echo 'âŒ Redis health check failed'
              exit 1
            fi
            
            # Test Kratos
            if curl -f http://localhost:4433/health/ready; then
              echo 'âœ… Kratos is healthy'
            else
              echo 'âŒ Kratos health check failed'
              exit 1
            fi
            
            echo 'âœ… All infrastructure services are healthy!'
          "

      - name: Infrastructure deployment summary
        run: |
          echo "## âš¡ Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: ${{ secrets.DO_DROPLET_IP }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PostgreSQL**: âœ… Running on port 5432" >> $GITHUB_STEP_SUMMARY
          echo "- **Redis**: âœ… Running on port 6379" >> $GITHUB_STEP_SUMMARY
          echo "- **Kratos**: âœ… Running on ports 4433/4434" >> $GITHUB_STEP_SUMMARY
          echo "- **Network**: âœ… battleone-network created" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Services**:" >> $GITHUB_STEP_SUMMARY
          echo "- PostgreSQL: Internal access via \`postgres:5432\`" >> $GITHUB_STEP_SUMMARY
          echo "- Redis: Internal access via \`redis:6379\`" >> $GITHUB_STEP_SUMMARY
          echo "- Kratos Public: Internal access via \`kratos:4433\`" >> $GITHUB_STEP_SUMMARY
          echo "- Kratos Admin: Internal access via \`kratos:4434\`" >> $GITHUB_STEP_SUMMARY