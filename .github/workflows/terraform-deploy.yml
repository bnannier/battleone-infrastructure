name: Deploy BattleOne Infrastructure

on:
  push:
    branches: [main]
    paths:
      - '*.tf'
      - 'terraform.tfvars'
      - 'docker-compose.yml'
      - 'kratos/**'
      - 'cloud-init.yml'
      - '.github/workflows/terraform-deploy.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy
          - plan
      auto_approve:
        description: 'Auto-approve the action (skip manual approval)'
        required: false
        default: false
        type: boolean

env:
  # DigitalOcean Configuration
  TF_VAR_digitalocean_token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
  TF_VAR_spaces_access_key: ${{ secrets.SPACES_ACCESS_KEY }}
  TF_VAR_spaces_secret_key: ${{ secrets.SPACES_SECRET_KEY }}
  TF_VAR_ssh_private_key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
  TF_VAR_ssh_public_key: ${{ secrets.DO_SSH_PUBLIC_KEY }}
  
  # Database Configuration
  TF_VAR_postgres_password: ${{ secrets.POSTGRES_PASSWORD }}
  TF_VAR_redis_password: ${{ secrets.REDIS_PASSWORD }}
  TF_VAR_postgres_db: ${{ secrets.POSTGRES_DB || 'battleone' }}
  TF_VAR_postgres_user: ${{ secrets.POSTGRES_USER || 'battleone_user' }}
  
  # Datadog Configuration
  TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY }}
  TF_VAR_datadog_site: ${{ secrets.DATADOG_SITE || 'datadoghq.com' }}
  
  # Infrastructure Settings
  TF_VAR_region: "tor1"
  TF_VAR_droplet_size: "s-2vcpu-4gb"
  
  # DigitalOcean Spaces for Terraform State
  AWS_ACCESS_KEY_ID: ${{ secrets.SPACES_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.SPACES_SECRET_KEY }}

jobs:
  terraform:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "ðŸ” Validating required secrets..."
          
          # Check DigitalOcean secrets
          if [ -z "${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" ]; then
            echo "âŒ DIGITALOCEAN_ACCESS_TOKEN secret is missing"
            exit 1
          fi
          
          # Check DigitalOcean Spaces secrets
          if [ -z "${{ secrets.SPACES_ACCESS_KEY }}" ]; then
            echo "âŒ SPACES_ACCESS_KEY secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.SPACES_SECRET_KEY }}" ]; then
            echo "âŒ SPACES_SECRET_KEY secret is missing"
            exit 1
          fi
          
          # Check SSH secrets
          if [ -z "${{ secrets.DO_SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ DO_SSH_PRIVATE_KEY secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.DO_SSH_PUBLIC_KEY }}" ]; then
            echo "âŒ DO_SSH_PUBLIC_KEY secret is missing"
            exit 1
          fi
          
          # Check database secrets
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then
            echo "âŒ POSTGRES_PASSWORD secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "âŒ REDIS_PASSWORD secret is missing"
            exit 1
          fi
          
          # Check Datadog secrets
          if [ -z "${{ secrets.DATADOG_API_KEY }}" ]; then
            echo "âŒ DATADOG_API_KEY secret is missing"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.6"

      - name: Terraform Format Check
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Init
        run: |
          echo "ðŸš€ Initializing Terraform with DigitalOcean Spaces backend..."
          terraform init

      - name: Terraform Validate
        run: |
          echo "ðŸ” Validating Terraform configuration..."
          terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          echo "ðŸ“‹ Creating Terraform plan..."
          terraform plan -detailed-exitcode -out=tfplan
          echo "plan_exitcode=$?" >> $GITHUB_OUTPUT

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { stdout } = await exec.getExecOutput('terraform', ['show', '-no-color', 'tfplan']);
            
            const output = `## ðŸš€ Terraform Plan
            
            <details>
            <summary>Show Plan</summary>
            
            \`\`\`
            ${stdout}
            \`\`\`
            
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Manual Approval
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.action == 'apply' && 
          github.event.inputs.auto_approve != 'true' &&
          steps.plan.outputs.plan_exitcode == '2'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.repository_owner }}
          minimum-approvals: 1
          issue-title: "ðŸš€ Terraform Apply Approval Required"
          issue-body: |
            **Terraform Apply Approval Required**
            
            Please review the Terraform plan above and approve this workflow to proceed with applying the BattleOne infrastructure changes.
            
            **Action**: ${{ github.event.inputs.action }}
            **Branch**: ${{ github.ref_name }}
            **Commit**: ${{ github.sha }}
            
            **Infrastructure includes:**
            - DigitalOcean droplet in Toronto (tor1)
            - PostgreSQL database
            - Redis cache
            - Kratos identity management

      - name: Terraform Apply
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        run: |
          echo "ðŸš€ Applying Terraform configuration..."
          terraform apply -auto-approve tfplan

      - name: Terraform Destroy
        if: |
          github.event_name == 'workflow_dispatch' && 
          github.event.inputs.action == 'destroy'
        run: |
          echo "ðŸ—‘ï¸ Destroying Terraform infrastructure..."
          terraform destroy -auto-approve

      - name: Infrastructure Health Check
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        run: |
          echo "ðŸ¥ Performing infrastructure health checks..."
          
          # Get the droplet IP from Terraform output
          DROPLET_IP=$(terraform output -raw droplet_ip)
          echo "ðŸŒ Infrastructure deployed to: $DROPLET_IP"
          
          # Wait for services to be ready
          echo "â³ Waiting for services to start..."
          sleep 120
          
          # Test basic connectivity
          echo "ðŸ” Testing basic connectivity..."
          if ping -c 3 $DROPLET_IP; then
            echo "âœ… Droplet is reachable"
          else
            echo "âŒ Droplet is not reachable"
            exit 1
          fi
          
          # Note: Kratos health check is skipped as it's now internal-only
          # The BFF will communicate with Kratos through the internal network
          echo "â„¹ï¸ Kratos API is configured for internal access only"

      - name: Output Infrastructure Information
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
        run: |
          echo "## ðŸŽ‰ BattleOne Infrastructure Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Droplet IP**: $(terraform output -raw droplet_ip)" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: Toronto (tor1)" >> $GITHUB_STEP_SUMMARY
          echo "- **PostgreSQL**: âœ… Available on internal network" >> $GITHUB_STEP_SUMMARY
          echo "- **Redis**: âœ… Available on internal network" >> $GITHUB_STEP_SUMMARY
          echo "- **Kratos**: âœ… Available internally at $(terraform output -raw kratos_internal_url)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… All services healthy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Kratos Internal URL**: $(terraform output -raw kratos_internal_url)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **SSH Access**: $(terraform output -raw ssh_connection)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Infrastructure is ready for BattleOne application deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. Use the connection strings from Terraform outputs in your application configuration" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment completion
        if: success()
        run: |
          echo "ðŸŽ‰ BattleOne infrastructure deployment completed successfully!"
          echo "ðŸ”— Infrastructure is ready at: $(terraform output -raw droplet_ip)"