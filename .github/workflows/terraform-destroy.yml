name: Destroy BattleOne Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DESTROY" to confirm infrastructure deletion'
        required: true
        type: string

env:
  # DigitalOcean Configuration
  TF_VAR_digitalocean_token: ${{ secrets.DO_USER_ACCESS_TOKEN }}
  TF_VAR_spaces_access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
  TF_VAR_spaces_secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
  TF_VAR_ssh_private_key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
  TF_VAR_ssh_public_key: ${{ secrets.DO_SSH_PUBLIC_KEY }}
  TF_VAR_laptop_ssh_public_key: ${{ secrets.DO_SSH_PUBLIC_KEY }}
  
  # Database Configuration
  TF_VAR_postgres_password: ${{ secrets.POSTGRES_PASSWORD }}
  TF_VAR_redis_password: ${{ secrets.REDIS_PASSWORD }}
  TF_VAR_postgres_db: ${{ secrets.POSTGRES_DB || 'battleone' }}
  TF_VAR_postgres_user: ${{ secrets.POSTGRES_USER || 'battleone_user' }}
  
  # Better Stack Configuration
  TF_VAR_betterstack_source_token: ${{ secrets.BETTERSTACK_SOURCE_TOKEN }}
  TF_VAR_betterstack_ingestion_host: ${{ secrets.BETTERSTACK_INGESTION_HOST || 'in.logs.betterstack.com' }}
  
  # Datadog Configuration (Deprecated - keeping for backward compatibility)
  TF_VAR_datadog_api_key: ${{ secrets.DATADOG_API_KEY || '' }}
  TF_VAR_datadog_site: ${{ secrets.DATADOG_SITE || 'datadoghq.com' }}
  
  # Infrastructure Settings
  TF_VAR_region: "tor1"
  TF_VAR_droplet_size: "s-1vcpu-1gb"
  
  # DigitalOcean Spaces for Terraform State
  AWS_ACCESS_KEY_ID: ${{ secrets.DO_SPACES_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.DO_SPACES_SECRET_KEY }}

jobs:
  destroy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ Invalid confirmation. You must type 'DESTROY' exactly to proceed."
            echo "You entered: '${{ github.event.inputs.confirmation }}'"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Validate required secrets
        run: |
          echo "ðŸ” Validating required secrets..."
          
          # Check critical DigitalOcean secrets
          if [ -z "${{ secrets.DO_USER_ACCESS_TOKEN }}" ]; then
            echo "âŒ DO_USER_ACCESS_TOKEN secret is missing"
            exit 1
          fi
          
          if [ -z "${{ secrets.DO_SPACES_ACCESS_KEY }}" ]; then
            echo "âŒ DO_SPACES_ACCESS_KEY secret is missing"
            exit 1
          fi
          
          echo "âœ… Required secrets are configured"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.6"

      - name: Cache Terraform
        uses: actions/cache@v3
        with:
          path: |
            ~/.terraform.d/plugin-cache
            .terraform
          key: terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
          restore-keys: terraform-

      - name: Terraform Init
        run: |
          echo "ðŸš€ Initializing Terraform..."
          terraform init -reconfigure

      - name: Terraform Plan Destroy
        id: plan
        run: |
          echo "ðŸ“‹ Creating destruction plan..."
          terraform plan -destroy -detailed-exitcode -out=destroy.tfplan
          EXITCODE=$?
          echo "Plan exit code: $EXITCODE"
          echo "plan_exitcode=$EXITCODE" >> $GITHUB_OUTPUT

      - name: Show Destroy Plan
        run: |
          echo "ðŸ” DEBUG: Plan exit code is: ${{ steps.plan.outputs.plan_exitcode }}"
          echo "ðŸ” DEBUG: Checking if exit code equals 2: ${{ steps.plan.outputs.plan_exitcode == 2 }}"
          echo "## âš ï¸ DESTRUCTION PLAN" >> $GITHUB_STEP_SUMMARY
          echo "**The following infrastructure will be PERMANENTLY DELETED:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          terraform show -no-color destroy.tfplan >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **This action CANNOT be undone!**" >> $GITHUB_STEP_SUMMARY


      - name: Terraform Destroy
        if: steps.plan.outputs.plan_exitcode == 2 || steps.plan.outputs.plan_exitcode == 0
        run: |
          echo "ðŸ—‘ï¸ DESTROYING INFRASTRUCTURE..."
          echo "Plan exit code was: ${{ steps.plan.outputs.plan_exitcode }}"
          echo "âš ï¸ This will permanently delete all resources!"
          if [ -f destroy.tfplan ]; then
            terraform apply -auto-approve destroy.tfplan
          else
            echo "âŒ No destroy plan found!"
            exit 1
          fi

      - name: Cleanup Remaining Resources
        if: steps.plan.outputs.plan_exitcode == 2 || steps.plan.outputs.plan_exitcode == 0
        run: |
          echo "ðŸ§¹ Cleaning up any remaining resources..."
          
          # Remove any remaining firewalls with battleone in the name
          echo "Checking for remaining firewalls..."
          doctl compute firewall list --format ID,Name --no-header | grep "battleone" | while read fw_id fw_name; do
            echo "Removing firewall: $fw_id ($fw_name)"
            doctl compute firewall delete "$fw_id" --force || echo "Failed to delete firewall $fw_id"
          done || true
          
          # Remove any remaining VPCs with battleone in the name  
          echo "Checking for remaining VPCs..."
          doctl vpcs list --format ID,Name --no-header | grep "battleone" | while read vpc_id vpc_name; do
            echo "Removing VPC: $vpc_id ($vpc_name)"
            doctl vpcs delete "$vpc_id" --force || echo "Failed to delete VPC $vpc_id"
          done || true
          
          # Remove any remaining volumes with battleone in the name
          echo "Checking for remaining volumes..."
          doctl compute volume list --format ID,Name --no-header | grep "battleone" | while read volume_id volume_name; do
            echo "Removing volume: $volume_id ($volume_name)"
            doctl compute volume delete "$volume_id" --force || echo "Failed to delete volume $volume_id"
          done || true
          
          echo "âœ… Resource cleanup completed"

      - name: Destruction Complete
        if: success()
        run: |
          echo "## ðŸ—‘ï¸ Infrastructure Destruction Complete" >> $GITHUB_STEP_SUMMARY
          echo "All BattleOne infrastructure has been permanently destroyed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Deleted:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DigitalOcean droplet" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PostgreSQL database" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Redis cache" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kratos identity management" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Associated networking and storage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’° **Cost savings**: Infrastructure costs have stopped." >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **To redeploy**: Use the main deployment workflow." >> $GITHUB_STEP_SUMMARY
          
          echo "ðŸŽ‰ Infrastructure destruction completed successfully!"
          echo "ðŸ’° Monthly costs (~$26.50) have been eliminated."