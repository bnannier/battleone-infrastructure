# Ory Kratos Configuration for BattleOne
# Complete identity management configuration

version: v1.1.0

# Data Source Name (DSN) for database connection
dsn: env://DSN

# Public and Admin APIs
serve:
  public:
    base_url: http://localhost:4433/
    cors:
      enabled: true
      allowed_origins:
        - http://localhost:3000
        - http://localhost:5173
        - http://localhost:8080
      allowed_methods:
        - POST
        - GET
        - PUT
        - PATCH
        - DELETE
      allowed_headers:
        - Authorization
        - Content-Type
        - X-Session-Token
      exposed_headers:
        - Content-Type
        - Set-Cookie
      allow_credentials: true
      debug: true

  admin:
    base_url: http://localhost:4434/

# Self-service flows configuration
selfservice:
  default_browser_return_url: http://localhost:5173/
  allowed_return_urls:
    - http://localhost:5173
    - http://localhost:3000

  # Methods configuration
  methods:
    password:
      enabled: true
      config:
        haveibeenpwned_enabled: true
        min_password_length: 8
        identifier_similarity_check_enabled: true

    totp:
      config:
        issuer: BattleOne
      enabled: true

    lookup_secret:
      enabled: true

    link:
      enabled: true
      config:
        lifespan: 1h
        base_url: http://localhost:4433

    code:
      enabled: true
      config:
        lifespan: 15m

  # Registration flow
  flows:
    registration:
      enabled: true
      ui_url: http://localhost:5173/auth/registration
      lifespan: 10m
      after:
        password:
          default_browser_return_url: http://localhost:5173/dashboard
        oidc:
          default_browser_return_url: http://localhost:5173/dashboard

    # Login flow
    login:
      ui_url: http://localhost:5173/auth/login
      lifespan: 10m
      after:
        password:
          hooks:
            - hook: require_verified_address
          default_browser_return_url: http://localhost:5173/dashboard
        oidc:
          default_browser_return_url: http://localhost:5173/dashboard

    # Logout flow
    logout:
      after:
        default_browser_return_url: http://localhost:5173/auth/login

    # Recovery flow
    recovery:
      enabled: true
      ui_url: http://localhost:5173/auth/recovery
      lifespan: 10m
      use: code
      after:
        default_browser_return_url: http://localhost:5173/auth/login

    # Verification flow
    verification:
      enabled: true
      ui_url: http://localhost:5173/auth/verification
      lifespan: 10m
      use: code
      after:
        default_browser_return_url: http://localhost:5173/dashboard

    # Settings flow
    settings:
      ui_url: http://localhost:5173/settings
      lifespan: 10m
      required_aal: highest_available
      after:
        password:
          default_browser_return_url: http://localhost:5173/settings
        profile:
          default_browser_return_url: http://localhost:5173/settings

    # Error handling
    error:
      ui_url: http://localhost:5173/error

# Log configuration
log:
  level: info
  format: json
  leak_sensitive_values: false

# Session configuration
session:
  cookie:
    persistent: true
    same_site: Lax
    name: ory_kratos_session
  lifespan: 24h

# Identity schema
identity:
  default_schema_id: default
  schemas:
    - id: default
      url: file:///etc/config/kratos/identity.schema.json

# Courier configuration for email delivery
courier:
  smtp:
    connection_uri: smtp://test:test@mailhog:1025/?skip_ssl_verify=true&legacy_ssl=true
    from_address: noreply@battleone.com
    from_name: BattleOne

  # Email templates
  templates:
    recovery:
      invalid:
        email:
          body:
            html: file:///etc/config/kratos/email-templates/recovery/invalid/email.body.html
            plaintext: file:///etc/config/kratos/email-templates/recovery/invalid/email.body.txt
          subject: file:///etc/config/kratos/email-templates/recovery/invalid/email.subject.txt
      valid:
        email:
          body:
            html: file:///etc/config/kratos/email-templates/recovery/valid/email.body.html
            plaintext: file:///etc/config/kratos/email-templates/recovery/valid/email.body.txt
          subject: file:///etc/config/kratos/email-templates/recovery/valid/email.subject.txt

    verification:
      invalid:
        email:
          body:
            html: file:///etc/config/kratos/email-templates/verification/invalid/email.body.html
            plaintext: file:///etc/config/kratos/email-templates/verification/invalid/email.body.txt
          subject: file:///etc/config/kratos/email-templates/verification/invalid/email.subject.txt
      valid:
        email:
          body:
            html: file:///etc/config/kratos/email-templates/verification/valid/email.body.html
            plaintext: file:///etc/config/kratos/email-templates/verification/valid/email.body.txt
          subject: file:///etc/config/kratos/email-templates/verification/valid/email.subject.txt

# Hash configuration
hashers:
  algorithm: bcrypt
  bcrypt:
    cost: 12


# Development settings (remove in production)
dev: true